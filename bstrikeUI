--// NO.FEAR DRAWING UI LIBRARY v5.0
--// Pure Drawing API - Undetected
local DrawLib = {}
local UIS = game:GetService("UserInputService")
local RS  = game:GetService("RunService")

local T = {
    BG      = Color3.fromRGB(28,28,28),
    Sidebar = Color3.fromRGB(20,20,20),
    TopBar  = Color3.fromRGB(18,18,18),
    Divider = Color3.fromRGB(50,50,50),
    Pink    = Color3.fromRGB(255,105,180),
    Text    = Color3.fromRGB(220,220,220),
    TextDim = Color3.fromRGB(110,110,110),
    Input   = Color3.fromRGB(38,38,38),
    TOn     = Color3.fromRGB(255,105,180),
    TOff    = Color3.fromRGB(55,55,55),
    White   = Color3.fromRGB(255,255,255),
    Black   = Color3.fromRGB(0,0,0),
    ActiveBG= Color3.fromRGB(38,28,38),
}

function DrawLib:CreateWindow(cfg)
    cfg = cfg or {}
    local W       = {}
    local tabs    = {}
    local activeTab = nil
    local visible = true
    local allD    = {}   -- every drawing ever created
    local handlers= {}   -- {tab, x,y,w,h, fn}
    local dragging= false
    local dox,doy = 0,0
    local px,py   = 160, 90  -- window top-left

    -- Window dimensions
    local WW,WH = 680,500
    local TBH   = 30
    local BBH   = 20
    local SBW   = 148
    local CPW   = (WW-SBW-2)  -- content panel width
    local LPW   = math.floor(CPW/2)-6
    local RPW   = LPW
    local LX0   = SBW+4        -- left column start (relative to px)
    local RX0   = SBW+4+LPW+8 -- right column start (relative to px)
    local CY0   = TBH+8        -- content start Y (relative to py)

    -- Create drawing + track
    local function mk(kind, props)
        local d = Drawing.new(kind)
        for k,v in pairs(props) do d[k] = v end
        table.insert(allD, d)
        return d
    end

    -- Move drawing by delta
    local function mv(d, ox, oy)
        pcall(function()
            if d.Position then
                d.Position = Vector2.new(d.Position.X+ox, d.Position.Y+oy)
            elseif d.From then
                d.From = Vector2.new(d.From.X+ox, d.From.Y+oy)
                d.To   = Vector2.new(d.To.X+ox,   d.To.Y+oy)
            end
        end)
    end

    -- Toggle all drawings
    local function setVis(v)
        visible = v
        for _,d in ipairs(allD) do pcall(function() d.Visible = (v and d._tabVisible ~= false) end) end
    end

    -- Core window drawings (use absolute px,py)
    local fBG  = mk("Square",{Position=Vector2.new(px,py),Size=Vector2.new(WW,WH),Color=T.BG,Filled=true,Transparency=1,ZIndex=1,Visible=true})
    local fOut = mk("Square",{Position=Vector2.new(px,py),Size=Vector2.new(WW,WH),Color=T.Divider,Filled=false,Thickness=1,ZIndex=2,Visible=true})
    local fTop = mk("Square",{Position=Vector2.new(px,py),Size=Vector2.new(WW,TBH),Color=T.TopBar,Filled=true,Transparency=1,ZIndex=2,Visible=true})
    local fTopD= mk("Line",{From=Vector2.new(px,py+TBH),To=Vector2.new(px+WW,py+TBH),Color=T.Divider,Thickness=1,ZIndex=3,Visible=true})
    local fLogo= mk("Text",{Text="NO.FEAR",Position=Vector2.new(px+10,py+8),Size=15,Color=T.Pink,Outline=true,OutlineColor=T.Black,ZIndex=4,Font=Drawing.Fonts.UI,Visible=true})
    local fGame= mk("Text",{Text=" | "..(cfg.Game or ""),Position=Vector2.new(px+76,py+9),Size=13,Color=T.TextDim,Outline=true,OutlineColor=T.Black,ZIndex=4,Font=Drawing.Fonts.UI,Visible=true})
    local fSide= mk("Square",{Position=Vector2.new(px,py+TBH),Size=Vector2.new(SBW,WH-TBH-BBH),Color=T.Sidebar,Filled=true,Transparency=1,ZIndex=2,Visible=true})
    local fSidD= mk("Line",{From=Vector2.new(px+SBW,py+TBH),To=Vector2.new(px+SBW,py+WH-BBH),Color=T.Divider,Thickness=1,ZIndex=3,Visible=true})
    local fMidD= mk("Line",{From=Vector2.new(px+SBW+LPW+10,py+TBH),To=Vector2.new(px+SBW+LPW+10,py+WH-BBH),Color=T.Divider,Thickness=1,ZIndex=3,Visible=true})
    local fBot = mk("Square",{Position=Vector2.new(px,py+WH-BBH),Size=Vector2.new(WW,BBH),Color=T.TopBar,Filled=true,Transparency=1,ZIndex=2,Visible=true})
    local fBotD= mk("Line",{From=Vector2.new(px,py+WH-BBH),To=Vector2.new(px+WW,py+WH-BBH),Color=T.Divider,Thickness=1,ZIndex=3,Visible=true})
    local fBotT= mk("Text",{Text=(cfg.Discord or "discord.gg/G9QSXsB9wY").." | "..(cfg.Version or "v1.0"),Position=Vector2.new(px+WW/2,py+WH-BBH+4),Size=11,Color=T.TextDim,Center=true,Outline=true,OutlineColor=T.Black,ZIndex=4,Font=Drawing.Fonts.UI,Visible=true})

    -- Stars
    local stars = {}
    local sTmr  = 0

    -- Input
    UIS.InputBegan:Connect(function(inp,gpe)
        if gpe then return end
        if inp.KeyCode == (cfg.ToggleKey or Enum.KeyCode.K) then
            setVis(not visible); return
        end
        if inp.UserInputType ~= Enum.UserInputType.MouseButton1 then return end
        if not visible then return end
        local mp = UIS:GetMouseLocation()
        local mx,my = mp.X, mp.Y
        -- Drag
        if mx>=px and mx<=px+WW and my>=py and my<=py+TBH then
            dragging=true; dox=mx-px; doy=my-py; return
        end
        -- Tab clicks
        for i,t in ipairs(tabs) do
            local tx=px+2; local tw=SBW-4
            local ty=py+TBH+(i-1)*34+2; local th=30
            if mx>=tx and mx<=tx+tw and my>=ty and my<=ty+th then
                for _,ot in ipairs(tabs) do
                    ot.bg.Color=T.Sidebar; ot.acc.Visible=false; ot.txt.Color=T.TextDim
                    for _,d in ipairs(ot.els) do d._tabVisible=false; if visible then pcall(function() d.Visible=false end) end end
                end
                t.bg.Color=T.ActiveBG; t.acc.Visible=true; t.txt.Color=T.Pink
                for _,d in ipairs(t.els) do d._tabVisible=true; if visible then pcall(function() d.Visible=true end) end end
                activeTab=t; return
            end
        end
        -- Element clicks
        if activeTab then
            for _,h in ipairs(handlers) do
                if h.tab==activeTab and mx>=h.x and mx<=h.x+h.w and my>=h.y and my<=h.y+h.h then
                    h.fn(); return
                end
            end
        end
    end)

    UIS.InputEnded:Connect(function(inp)
        if inp.UserInputType==Enum.UserInputType.MouseButton1 then dragging=false end
    end)

    RS.RenderStepped:Connect(function(dt)
        if dragging then
            local mp=UIS:GetMouseLocation()
            local nx=mp.X-dox; local ny=mp.Y-doy
            local ox=nx-px; local oy=ny-py
            px=nx; py=ny
            for _,d in ipairs(allD) do mv(d,ox,oy) end
            for _,h in ipairs(handlers) do h.x=h.x+ox; h.y=h.y+oy end
            for _,s in ipairs(stars) do
                s.a.Position=Vector2.new(s.a.Position.X+ox,s.a.Position.Y+oy)
                s.b.Position=Vector2.new(s.b.Position.X+ox,s.b.Position.Y+oy)
                s.sy=s.sy+oy
            end
        end
        if visible then
            sTmr=sTmr+dt
            if sTmr>0.4 then sTmr=0
                local sx=px+math.random(10,WW-10); local sy=py-5
                local sz=math.random(1,3); local spd=math.random(60,140)
                local a=Drawing.new("Square"); a.Size=Vector2.new(sz,sz*3); a.Position=Vector2.new(sx,sy); a.Color=T.White; a.Filled=true; a.Transparency=0.6; a.ZIndex=10; a.Visible=true
                local b=Drawing.new("Square"); b.Size=Vector2.new(sz*3,sz); b.Position=Vector2.new(sx-sz,sy+sz); b.Color=T.White; b.Filled=true; b.Transparency=0.6; b.ZIndex=10; b.Visible=true
                table.insert(stars,{a=a,b=b,sy=sy,spd=spd})
            end
            local alive={}
            for _,s in ipairs(stars) do
                s.sy=s.sy+s.spd*dt
                s.a.Position=Vector2.new(s.a.Position.X,s.sy)
                s.b.Position=Vector2.new(s.b.Position.X,s.sy+s.a.Size.Y/2)
                if s.sy<py+WH+20 then table.insert(alive,s)
                else s.a.Visible=false;s.b.Visible=false;s.a:Remove();s.b:Remove() end
            end
            stars=alive
        end
    end)

    function W:AddTab(tcfg)
        tcfg=tcfg or {}
        local Tab={els={},lds={}} -- els=content drawings, lds=all tab drawings (sidebar+content)
        local ti=#tabs+1
        local loffY=0; local roffY=0 -- content Y offsets (left/right columns)

        -- Sidebar button
        local tbx=px+2; local tby=py+TBH+(ti-1)*34+2
        local bg =mk("Square",{Position=Vector2.new(tbx,tby),Size=Vector2.new(SBW-4,30),Color=T.Sidebar,Filled=true,Transparency=1,ZIndex=3,Visible=true})
        local acc=mk("Square",{Position=Vector2.new(tbx+1,tby+6),Size=Vector2.new(3,18),Color=T.Pink,Filled=true,Transparency=1,ZIndex=4,Visible=false})
        local txt=mk("Text",{Text=tcfg.Name or "Tab",Position=Vector2.new(tbx+10,tby+9),Size=13,Color=T.TextDim,Outline=true,OutlineColor=T.Black,ZIndex=4,Font=Drawing.Fonts.UI,Visible=true})
        Tab.bg=bg; Tab.acc=acc; Tab.txt=txt

        -- Mark sidebar drawings as non-content (always visible when UI visible)
        bg._tabVisible=true; acc._tabVisible=false; txt._tabVisible=true

        table.insert(tabs,Tab)
        if ti==1 then bg.Color=T.ActiveBG; acc.Visible=true; txt.Color=T.Pink; activeTab=Tab end

        function Tab:AddSection(sname,side)
            local Sec={}
            local isR=(side=="right")
            -- Absolute positions for this section elements
            local function ax() return px+(isR and RX0 or LX0) end
            local function ay() return py+CY0+(isR and roffY or loffY) end

            -- Section header
            local hx=ax(); local hy=ay()
            local hdr=mk("Text",{Text=sname or "",Position=Vector2.new(hx,hy),Size=13,Color=T.Pink,Outline=true,OutlineColor=T.Black,ZIndex=5,Font=Drawing.Fonts.UI,Visible=false})
            local hdl=mk("Line",{From=Vector2.new(hx,hy+16),To=Vector2.new(hx+LPW,hy+16),Color=T.Divider,Thickness=1,ZIndex=4,Visible=false})
            hdr._tabVisible=false; hdl._tabVisible=false
            table.insert(Tab.els,hdr); table.insert(Tab.els,hdl)
            if isR then roffY=roffY+24 else loffY=loffY+24 end

            -- Helper to add element drawings + click handler
            local function addEl(ds, ex, ey, ew, eh, fn)
                for _,d in ipairs(ds) do
                    d._tabVisible=false
                    table.insert(Tab.els,d)
                end
                if fn then
                    table.insert(handlers,{tab=Tab,x=ex,y=ey,w=ew,h=eh,fn=fn})
                end
            end

            function Sec:AddToggle(c)
                c=c or {}
                local state=c.Default or false
                local ex=ax(); local ey=ay()
                local lbl=mk("Text",{Text=c.Name or "",Position=Vector2.new(ex+2,ey+3),Size=13,Color=T.Text,Outline=true,OutlineColor=T.Black,ZIndex=5,Font=Drawing.Fonts.UI,Visible=false})
                local tbg=mk("Square",{Position=Vector2.new(ex+LPW-30,ey+2),Size=Vector2.new(28,14),Color=state and T.TOn or T.TOff,Filled=true,Transparency=1,ZIndex=5,Visible=false})
                local knb=mk("Square",{Position=Vector2.new(ex+LPW-(state and 16 or 30)+2,ey+3),Size=Vector2.new(10,10),Color=T.White,Filled=true,Transparency=1,ZIndex=6,Visible=false})
                addEl({lbl,tbg,knb},ex+LPW-32,ey,32,18,function()
                    state=not state
                    tbg.Color=state and T.TOn or T.TOff
                    knb.Position=Vector2.new(ex+LPW-(state and 16 or 30)+2,knb.Position.Y)
                    if c.Callback then pcall(c.Callback,state) end
                end)
                if isR then roffY=roffY+22 else loffY=loffY+22 end
            end

            function Sec:AddSlider(c)
                c=c or {}
                local mn=c.Min or 0; local mx2=c.Max or 100; local val=c.Default or 0
                local slW=LPW-4
                local ex=ax(); local ey=ay()
                local lbl=mk("Text",{Text=c.Name or "",Position=Vector2.new(ex+2,ey+2),Size=13,Color=T.Text,Outline=true,OutlineColor=T.Black,ZIndex=5,Font=Drawing.Fonts.UI,Visible=false})
                local vTx=mk("Text",{Text=tostring(val),Position=Vector2.new(ex+LPW-4,ey+2),Size=12,Color=T.Pink,Outline=true,OutlineColor=T.Black,ZIndex=5,Font=Drawing.Fonts.UI,Visible=false})
                local sbg=mk("Square",{Position=Vector2.new(ex+2,ey+18),Size=Vector2.new(slW,5),Color=T.Input,Filled=true,Transparency=1,ZIndex=5,Visible=false})
                local sfl=mk("Square",{Position=Vector2.new(ex+2,ey+18),Size=Vector2.new(slW*((val-mn)/math.max(mx2-mn,1)),5),Color=T.Pink,Filled=true,Transparency=1,ZIndex=6,Visible=false})
                addEl({lbl,vTx,sbg,sfl},ex+2,ey+15,slW,12,function()
                    local conn; conn=RS.RenderStepped:Connect(function()
                        local mp2=UIS:GetMouseLocation()
                        local pct=math.clamp((mp2.X-(ex+2))/slW,0,1)
                        val=math.floor(mn+pct*(mx2-mn))
                        sfl.Size=Vector2.new(slW*pct,5)
                        vTx.Text=tostring(val)
                        if not UIS:IsMouseButtonPressed(Enum.UserInputType.MouseButton1) then
                            conn:Disconnect()
                            if c.Callback then pcall(c.Callback,val) end
                        end
                    end)
                end)
                if isR then roffY=roffY+32 else loffY=loffY+32 end
            end

            function Sec:AddDropdown(c)
                c=c or {}
                local opts=c.Options or {}; local sel=c.Default or (opts[1] or ""); local oi=1
                for i,v in ipairs(opts) do if v==sel then oi=i end end
                local ex=ax(); local ey=ay()
                local dlbl=mk("Text",{Text=c.Name or "",Position=Vector2.new(ex+2,ey+2),Size=13,Color=T.Text,Outline=true,OutlineColor=T.Black,ZIndex=5,Font=Drawing.Fonts.UI,Visible=false})
                local dbg =mk("Square",{Position=Vector2.new(ex+2,ey+18),Size=Vector2.new(LPW-4,18),Color=T.Input,Filled=true,Transparency=1,ZIndex=5,Visible=false})
                local dtx =mk("Text",{Text=sel,Position=Vector2.new(ex+6,ey+21),Size=12,Color=T.Text,Outline=true,OutlineColor=T.Black,ZIndex=6,Font=Drawing.Fonts.UI,Visible=false})
                local darr=mk("Text",{Text="v",Position=Vector2.new(ex+LPW-8,ey+21),Size=11,Color=T.Pink,Outline=true,OutlineColor=T.Black,ZIndex=6,Font=Drawing.Fonts.UI,Visible=false})
                addEl({dlbl,dbg,dtx,darr},ex+2,ey+16,LPW-4,22,function()
                    if #opts==0 then return end
                    oi=oi%#opts+1; sel=opts[oi]; dtx.Text=sel
                    if c.Callback then pcall(c.Callback,sel) end
                end)
                if isR then roffY=roffY+44 else loffY=loffY+44 end
            end

            function Sec:AddLabel(c)
                c=c or {}
                local ex=ax(); local ey=ay()
                local lbl=mk("Text",{Text=c.Text or "",Position=Vector2.new(ex+2,ey+2),Size=12,Color=c.Color or T.TextDim,Outline=true,OutlineColor=T.Black,ZIndex=5,Font=Drawing.Fonts.UI,Visible=false})
                addEl({lbl},0,0,0,0,nil)
                if isR then roffY=roffY+18 else loffY=loffY+18 end
            end

            function Sec:AddButton(c)
                c=c or {}
                local ex=ax(); local ey=ay()
                local bbg=mk("Square",{Position=Vector2.new(ex+2,ey),Size=Vector2.new(LPW-4,20),Color=T.Input,Filled=true,Transparency=1,ZIndex=5,Visible=false})
                local btx=mk("Text",{Text=c.Name or "Button",Position=Vector2.new(ex+LPW/2,ey+4),Size=13,Color=T.Text,Center=true,Outline=true,OutlineColor=T.Black,ZIndex=6,Font=Drawing.Fonts.UI,Visible=false})
                addEl({bbg,btx},ex+2,ey,LPW-4,20,function()
                    if c.Callback then pcall(c.Callback) end
                end)
                if isR then roffY=roffY+26 else loffY=loffY+26 end
            end

            return Sec
        end
        return Tab
    end

    function W:Finalize()
        if #tabs>0 then
            for _,d in ipairs(tabs[1].els) do
                d._tabVisible=true
                pcall(function() d.Visible=true end)
            end
        end
    end

    function W:Destroy()
        for _,d in ipairs(allD) do pcall(function() d:Remove() end) end
        for _,s in ipairs(stars) do s.a:Remove();s.b:Remove() end
    end

    return W
end

return DrawLib
